<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孕妇健康管理系统 - 用户管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/admin.css">
</head>
<body>
    <div class="page fade-in" id="usersPage">
        <div class="card">
            <div class="card-header">
                <div class="card-title">用户管理</div>
                <div class="card-actions">
                    <button class="btn btn-primary" id="addUserBtn">
                        <i class="fas fa-plus"></i> 添加用户
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                <form class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>用户名:</label>
                            <input type="text" id="userName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="text" id="userEmail" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>角色:</label>
                            <select id="userRole" class="form-control">
                                <option value="">全部</option>
                                <option value="USER">普通用户</option>
                                <option value="ADMIN">管理员</option>
                                <option value="DOCTOR">医生</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="searchUserBtn">
                                <i class="fas fa-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-outline" id="resetUserBtn">
                                <i class="fas fa-redo"></i> 重置
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- 用户表格 -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="pagination" id="userPagination">
                    <button class="btn btn-outline" id="prevUserPage"><i class="fas fa-chevron-left"></i></button>
                    <span id="userPageInfo">第 1 页，共 1 页</span>
                    <button class="btn btn-outline" id="nextUserPage"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户编辑模态框 -->
    <div class="modal" id="userModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="modalTitle">编辑用户</h3>
                <button class="btn btn-outline" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label>用户名:</label>
                        <input type="text" id="modalUserName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>邮箱:</label>
                        <input type="email" id="modalUserEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>角色:</label>
                        <select id="modalUserRole" class="form-control" required>
                            <option value="USER">普通用户</option>
                            <option value="ADMIN">管理员</option>
                            <option value="DOCTOR">医生</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>密码:</label>
                        <input type="password" id="modalUserPassword" class="form-control">
                        <small>留空则不修改密码</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelUserBtn">取消</button>
                <button class="btn btn-primary" id="saveUserBtn">保存</button>
            </div>
        </div>
    </div>

    <script src="./lib/js/vue.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script src="./js/main.js"></script>
    <script>
        // 全局变量
        let currentUserPage = 1;
        let currentUserSearchName = '';
        let currentUserSearchEmail = '';
        let currentUserSearchRole = '';
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载用户列表
            loadUserList(1);
            
            // 绑定事件
            bindUserEvents();
        });
        
        // 绑定用户相关事件
        function bindUserEvents() {
            // 添加用户按钮
            document.getElementById('addUserBtn').addEventListener('click', function() {
                // 清空表单
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('modalTitle').textContent = '添加用户';
                document.getElementById('userModal').style.display = 'block';
            });
            
            // 关闭模态框按钮
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('userModal').style.display = 'none';
            });
            
            // 取消按钮
            document.getElementById('cancelUserBtn').addEventListener('click', function() {
                document.getElementById('userModal').style.display = 'none';
            });
            
            // 保存用户按钮
            document.getElementById('saveUserBtn').addEventListener('click', function() {
                saveUser();
            });
            
            // 用户查询按钮
            document.getElementById('searchUserBtn').addEventListener('click', function() {
                currentUserSearchName = document.getElementById('userName').value;
                currentUserSearchEmail = document.getElementById('userEmail').value;
                currentUserSearchRole = document.getElementById('userRole').value;
                loadUserList(1);
            });
            
            // 用户重置按钮
            document.getElementById('resetUserBtn').addEventListener('click', function() {
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userRole').value = '';
                currentUserSearchName = '';
                currentUserSearchEmail = '';
                currentUserSearchRole = '';
                loadUserList(1);
            });
            
            // 上一页按钮
            document.getElementById('prevUserPage').addEventListener('click', function() {
                if (currentUserPage > 1) {
                    loadUserList(currentUserPage - 1);
                }
            });
            
            // 下一页按钮
            document.getElementById('nextUserPage').addEventListener('click', function() {
                loadUserList(currentUserPage + 1);
            });
        }
        
        // 加载用户列表
        function loadUserList(page, name = '', email = '', role = '') {
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('size', 10);
            
            if (name || currentUserSearchName) {
                params.append('username', name || currentUserSearchName);
            }
            if (email || currentUserSearchEmail) {
                params.append('email', email || currentUserSearchEmail);
            }
            if (role || currentUserSearchRole) {
                params.append('role', role || currentUserSearchRole);
            }
            
            axios.get(`/api/users/page?${params.toString()}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const data = response.data.data;
                        renderUserTable(data.records);
                        updateUserPagination(data);
                        currentUserPage = data.current;
                    } else {
                        alert('加载用户列表失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('加载用户列表失败');
                });
        }
        
        // 渲染用户表格
        function renderUserTable(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            if (!users || users.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center">暂无数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id || ''}</td>
                    <td>${user.username || ''}</td>
                    <td>${user.email || ''}</td>
                    <td>${getUserRoleName(user.role) || ''}</td>
                    <td>${formatDate(user.createTime) || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 更新分页信息
        function updateUserPagination(pageInfo) {
            document.getElementById('userPageInfo').textContent = 
                `第 ${pageInfo.current} 页，共 ${pageInfo.pages} 页`;
            
            // 禁用/启用分页按钮
            document.getElementById('prevUserPage').disabled = pageInfo.current === 1;
            document.getElementById('nextUserPage').disabled = pageInfo.current === pageInfo.pages;
        }
        
        // 编辑用户
        function editUser(userId) {
            axios.get(`/api/users/${userId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const user = response.data.data;
                        document.getElementById('userId').value = user.id;
                        document.getElementById('modalUserName').value = user.username;
                        document.getElementById('modalUserEmail').value = user.email;
                        document.getElementById('modalUserRole').value = user.role;
                        document.getElementById('modalUserPassword').value = '';
                        document.getElementById('modalTitle').textContent = '编辑用户';
                        document.getElementById('userModal').style.display = 'block';
                    } else {
                        alert('获取用户信息失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户信息失败');
                });
        }
        
        // 保存用户
        function saveUser() {
            const userId = document.getElementById('userId').value;
            const userData = {
                username: document.getElementById('modalUserName').value,
                email: document.getElementById('modalUserEmail').value,
                role: document.getElementById('modalUserRole').value
            };
            
            // 如果填写了密码，则添加到数据中
            const password = document.getElementById('modalUserPassword').value;
            if (password) {
                userData.password = password;
            }
            
            let url = '/api/users';
            let method = 'post';
            
            if (userId) {
                url += '/' + userId;
                method = 'put';
                // 编辑时如果没有填写密码，则不发送密码字段
                if (!password) {
                    delete userData.password;
                }
            }
            
            axios({
                method: method,
                url: url,
                data: userData
            })
                .then(response => {
                    if (response.data.code === 200) {
                        alert('保存成功');
                        document.getElementById('userModal').style.display = 'none';
                        loadUserList(currentUserPage);
                    } else {
                        alert('保存失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败');
                });
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？')) {
                axios.delete(`/api/users/${userId}`)
                    .then(response => {
                        if (response.data.code === 200) {
                            alert('删除成功');
                            loadUserList(currentUserPage);
                        } else {
                            alert('删除失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('删除失败');
                    });
            }
        }
        
        // 获取用户角色名称
        function getUserRoleName(role) {
            switch (role) {
                case 'USER': return '普通用户';
                case 'ADMIN': return '管理员';
                case 'DOCTOR': return '医生';
                default: return role;
            }
        }
    </script>
</body>
</html>