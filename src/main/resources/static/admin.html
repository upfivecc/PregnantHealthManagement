<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孕妇健康管理系统 - 管理后台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- 侧边栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-baby"></i>
                    </div>
                    <div class="logo-text">孕妇健康管理系统</div>
                </div>
                <button class="toggle-btn" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>仪表盘</span>
                </div>
                <div class="menu-item" data-page="users">
                    <i class="fas fa-users"></i>
                    <span>用户管理</span>
                </div>
                <div class="menu-item" data-page="doctors">
                    <i class="fas fa-user-md"></i>
                    <span>医生管理</span>
                </div>
                <div class="menu-item" data-page="appointments">
                    <i class="fas fa-calendar-check"></i>
                    <span>预约管理</span>
                </div>
                <div class="menu-item" data-page="knowledge">
                    <i class="fas fa-book-medical"></i>
                    <span>知识管理</span>
                </div>
                <div class="menu-item" data-page="consultations">
                    <i class="fas fa-comments"></i>
                    <span>咨询管理</span>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 顶部导航栏 -->
            <div class="header">
                <div class="header-left">
                    <h1 id="pageTitle">仪表盘</h1>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <div class="user-avatar">管</div>
                        <div class="user-name">管理员</div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="content">
                <!-- 仪表盘页面 -->
                <div class="page fade-in" id="dashboardPage">
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="userCount">0</h3>
                                <p>用户总数</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon doctors">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="doctorCount">0</h3>
                                <p>医生总数</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon appointments">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayAppointmentCount">0</h3>
                                <p>今日预约</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon consultations">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="unrepliedCount">0</h3>
                                <p>未回复咨询</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">系统公告</div>
                        </div>
                        <div class="card-body">
                            <p>欢迎使用孕妇健康管理系统管理后台</p>
                        </div>
                    </div>
                </div>
                
                <!-- 用户编辑模态框 -->
                <div class="modal" id="userModal" style="display: none;">
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <h3 id="modalTitle">编辑用户</h3>
                            <button class="btn btn-outline" id="closeModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="userForm">
                                <input type="hidden" id="userId">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="form-group">
                                    <label>密码</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <div class="form-group">
                                    <label>邮箱</label>
                                    <input type="email" class="form-control" id="email">
                                </div>
                                <div class="form-group">
                                    <label>真实姓名</label>
                                    <input type="text" class="form-control" id="realName">
                                </div>
                                <div class="form-group">
                                    <label>角色</label>
                                    <select class="form-control" id="role">
                                        <option value="USER">普通用户</option>
                                        <option value="DOCTOR">医生</option>
                                        <option value="ADMIN">管理员</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>状态</label>
                                    <select class="form-control" id="status">
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelBtn">取消</button>
                            <button class="btn btn-primary" id="saveUserBtn">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 用户管理页面 -->
                <div class="page fade-in" id="usersPage" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">用户管理</div>
                            <button class="btn btn-primary" id="addUserBtn">
                                <i class="fas fa-plus"></i> 添加用户
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" class="form-control" placeholder="请输入用户名">
                                </div>
                                <div class="form-group">
                                    <label>角色</label>
                                    <select class="form-control">
                                        <option value="">全部</option>
                                        <option value="USER">普通用户</option>
                                        <option value="DOCTOR">医生</option>
                                        <option value="ADMIN">管理员</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary">
                                        <i class="fas fa-search"></i> 查询
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户名</th>
                                            <th>邮箱</th>
                                            <th>真实姓名</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态生成用户列表 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination">
                                <div class="page-info">显示 0 到 0 条记录，共 0 条</div>
                                <div class="page-controls">
                                    <button class="btn btn-outline" id="prevUserPage"><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-primary" id="currentUserPageNum">1</button>
                                    <button class="btn btn-outline" id="nextUserPage"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 医生编辑模态框 -->
                <div class="modal" id="doctorModal" style="display: none;">
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <h3 id="doctorModalTitle">编辑医生</h3>
                            <button class="btn btn-outline" id="closeDoctorModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="doctorForm">
                                <input type="hidden" id="doctorId">
                                <div class="form-group">
                                    <label>用户ID</label>
                                    <input type="number" class="form-control" id="doctorUserId" required>
                                </div>
                                <div class="form-group">
                                    <label>医院</label>
                                    <input type="text" class="form-control" id="doctorHospital" required>
                                </div>
                                <div class="form-group">
                                    <label>科室</label>
                                    <input type="text" class="form-control" id="doctorDepartment" required>
                                </div>
                                <div class="form-group">
                                    <label>职称</label>
                                    <input type="text" class="form-control" id="doctorTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>专长</label>
                                    <input type="text" class="form-control" id="doctorSpecialty">
                                </div>
                                <div class="form-group">
                                    <label>简介</label>
                                    <textarea class="form-control" id="doctorIntroduction" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelDoctorBtn">取消</button>
                            <button class="btn btn-primary" id="saveDoctorBtn">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 医生管理页面 -->
                <div class="page fade-in" id="doctorsPage" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">医生管理</div>
                            <button class="btn btn-primary" id="addDoctorBtn">
                                <i class="fas fa-plus"></i> 添加医生
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 添加查询表单 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>医生姓名</label>
                                    <input type="text" class="form-control" id="doctorRealName" placeholder="请输入医生姓名">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" id="searchDoctorBtn">
                                        <i class="fas fa-search"></i> 查询
                                    </button>
                                    <button class="btn btn-outline" id="resetDoctorBtn">
                                        <i class="fas fa-refresh"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户ID</th>
                                            <th>医院</th>
                                            <th>科室</th>
                                            <th>职称</th>
                                            <th>专长</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态生成医生列表 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination">
                                <div class="page-info">显示 0 到 0 条记录，共 0 条</div>
                                <div class="page-controls">
                                    <button class="btn btn-outline" onclick="loadDoctorList(currentDoctorPage - 1)" id="prevDoctorPage"><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-primary" id="currentDoctorPageNum">1</button>
                                    <button class="btn btn-outline" onclick="loadDoctorList(currentDoctorPage + 1)" id="nextDoctorPage"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 预约管理页面 -->
                <div class="page fade-in" id="appointmentsPage" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">预约管理</div>
                        </div>
                        <div class="card-body">
                            <!-- 添加查询表单 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>用户姓名</label>
                                    <input type="text" class="form-control" id="appointmentUserRealName" placeholder="请输入用户姓名">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" id="searchAppointmentBtn">
                                        <i class="fas fa-search"></i> 查询
                                    </button>
                                    <button class="btn btn-outline" id="resetAppointmentBtn">
                                        <i class="fas fa-refresh"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户</th>
                                            <th>医院</th>
                                            <th>科室</th>
                                            <th>医生职称</th>
                                            <th>预约时间</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态生成预约列表 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination">
                                <div class="page-info">显示 0 到 0 条记录，共 0 条</div>
                                <div class="page-controls">
                                    <button class="btn btn-outline" onclick="loadAppointmentList(currentAppointmentPage - 1)" id="prevAppointmentPage"><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-primary" id="currentAppointmentPageNum">1</button>
                                    <button class="btn btn-outline" onclick="loadAppointmentList(currentAppointmentPage + 1)" id="nextAppointmentPage"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 知识管理页面 -->
                <div class="page fade-in" id="knowledgePage" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">知识管理</div>
                            <button class="btn btn-primary" id="addKnowledgeBtn">
                                <i class="fas fa-plus"></i> 发布知识
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 添加查询表单 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>标题</label>
                                    <input type="text" class="form-control" id="knowledgeTitle" placeholder="请输入标题">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" id="searchKnowledgeBtn">
                                        <i class="fas fa-search"></i> 查询
                                    </button>
                                    <button class="btn btn-outline" id="resetKnowledgeBtn">
                                        <i class="fas fa-refresh"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>标题</th>
                                            <th>分类</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态生成知识列表 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination">
                                <div class="page-info">显示 0 到 0 条记录，共 0 条</div>
                                <div class="page-controls">
                                    <button class="btn btn-outline" onclick="loadKnowledgeList(currentKnowledgePage - 1)" id="prevKnowledgePage"><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-primary" id="currentKnowledgePageNum">1</button>
                                    <button class="btn btn-outline" onclick="loadKnowledgeList(currentKnowledgePage + 1)" id="nextKnowledgePage"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 咨询管理页面 -->
                <div class="page fade-in" id="consultationsPage" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">咨询管理</div>
                        </div>
                        <div class="card-body">
                            <!-- 添加查询表单 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>咨询标题</label>
                                    <input type="text" class="form-control" id="consultationTitle" placeholder="请输入咨询标题">
                                </div>
                                <div class="form-group">
                                    <label>状态</label>
                                    <select class="form-control" id="consultationStatus">
                                        <option value="">全部</option>
                                        <option value="0">未回复</option>
                                        <option value="1">已回复</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" id="searchConsultationBtn">
                                        <i class="fas fa-search"></i> 查询
                                    </button>
                                    <button class="btn btn-outline" id="resetConsultationBtn">
                                        <i class="fas fa-refresh"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户</th>
                                            <th>咨询标题</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态生成咨询列表 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination">
                                <div class="page-info">显示 0 到 0 条记录，共 0 条</div>
                                <div class="page-controls">
                                    <button class="btn btn-outline" onclick="loadConsultationList(currentConsultationPage - 1)" id="prevConsultationPage"><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-primary" id="currentConsultationPageNum">1</button>
                                    <button class="btn btn-outline" onclick="loadConsultationList(currentConsultationPage + 1)" id="nextConsultationPage"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 侧边栏切换
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
        
        // 页面切换
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page');
        const pageTitle = document.getElementById('pageTitle');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                // 移除所有菜单项的活动状态
                menuItems.forEach(i => i.classList.remove('active'));
                // 添加当前菜单项的活动状态
                this.classList.add('active');
                
                // 隐藏所有页面
                pages.forEach(page => {
                    page.style.display = 'none';
                });
                
                // 显示选中的页面
                const pageId = this.getAttribute('data-page') + 'Page';
                document.getElementById(pageId).style.display = 'block';
                
                // 更新页面标题
                const titles = {
                    'dashboard': '仪表盘',
                    'users': '用户管理',
                    'doctors': '医生管理',
                    'appointments': '预约管理',
                    'knowledge': '知识管理',
                    'consultations': '咨询管理'
                };
                pageTitle.textContent = titles[this.getAttribute('data-page')];
                
                // 如果切换到用户管理页面，则加载用户数据
                if (this.getAttribute('data-page') === 'users') {
                    loadUserList(1);
                }
            });
        });
        
        // 模拟统计数据
        document.getElementById('userCount').textContent = '128';
        document.getElementById('doctorCount').textContent = '15';
        document.getElementById('todayAppointmentCount').textContent = '8';
        document.getElementById('unrepliedCount').textContent = '3';
        
        // 用户管理功能
        let currentPage = 1;
        const pageSize = 10;
        
        // 查询用户列表
        function loadUserList(page = 1, username = '', role = '') {
            currentPage = page;
            const url = `/api/users?page=${page}&size=${pageSize}${role ? '&role=' + role : ''}`;
            
            console.log('正在请求用户列表:', url);
            fetch(url)
                .then(response => {
                    console.log('收到响应:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('解析后的数据:', data);
                    if (data.code === 200) {
                        updateUserTable(data.data.records);
                        updatePagination(data.data);
                    } else {
                        alert('获取用户列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户列表失败');
                });
        }
        
        // 更新用户表格
        function updateUserTable(users) {
            const tbody = document.querySelector('#usersPage tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email || ''}</td>
                    <td>${user.realName || ''}</td>
                    <td><span class="tag tag-primary">${getRoleName(user.role)}</span></td>
                    <td><span class="tag ${user.status === 1 ? 'tag-success' : 'tag-danger'}">${user.status === 1 ? '启用' : '禁用'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline view-user" data-id="${user.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline edit-user" data-id="${user.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger delete-user" data-id="${user.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 绑定事件
            bindUserActions();
        }
        
        // 获取角色名称
        function getRoleName(role) {
            const roles = {
                'USER': '普通用户',
                'DOCTOR': '医生',
                'ADMIN': '管理员'
            };
            return roles[role] || role;
        }
        
        // 更新分页信息
        function updatePagination(pageData) {
            const pageInfo = document.querySelector('#usersPage .page-info');
            const pageControls = document.querySelector('#usersPage .page-controls');
            const currentPageNum = document.querySelector('#usersPage #currentUserPageNum');
            const prevPageBtn = document.querySelector('#usersPage #prevUserPage');
            const nextPageBtn = document.querySelector('#usersPage #nextUserPage');
            
            // 计算总页数
            const totalPages = Math.ceil(pageData.total / pageData.pageSize);
            
            // 更新页面信息
            pageInfo.textContent = `显示 ${(pageData.currentPage - 1) * pageData.pageSize + 1} 到 ${Math.min(pageData.currentPage * pageData.pageSize, pageData.total)} 条记录，共 ${pageData.total} 条`;
            
            // 更新当前页码
            currentPageNum.textContent = pageData.currentPage;
            
            // 更新按钮状态
            prevPageBtn.disabled = pageData.currentPage <= 1;
            nextPageBtn.disabled = pageData.currentPage >= totalPages;
        }
        
        // 绑定用户操作事件
        function bindUserActions() {
            // 查看用户
            document.querySelectorAll('.view-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    viewUser(userId);
                });
            });
            
            // 编辑用户
            document.querySelectorAll('.edit-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    editUser(userId);
                });
            });
            
            // 删除用户
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    deleteUser(userId);
                });
            });
        }
        
        // 查看用户详情
        function viewUser(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const user = data.data;
                        alert(`用户详情:
ID: ${user.id}
用户名: ${user.username}
邮箱: ${user.email || ''}
真实姓名: ${user.realName || ''}
角色: ${getRoleName(user.role)}
状态: ${user.status === 1 ? '启用' : '禁用'}`);
                    } else {
                        alert('获取用户详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户详情失败');
                });
        }
        
        // 编辑用户
        function editUser(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const user = data.data;
                        // 填充表单数据
                        document.getElementById('userId').value = user.id;
                        document.getElementById('username').value = user.username;
                        document.getElementById('password').value = '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('realName').value = user.realName || '';
                        document.getElementById('role').value = user.role;
                        document.getElementById('status').value = user.status;
                        
                        // 显示模态框
                        document.getElementById('modalTitle').textContent = '编辑用户';
                        document.getElementById('userModal').style.display = 'block';
                    } else {
                        alert('获取用户信息失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户信息失败');
                });
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？')) {
                fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('用户删除成功');
                        // 重新加载用户列表
                        loadUserList(currentPage);
                    } else {
                        alert('删除用户失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除用户失败');
                });
            }
        }
        
        // 为查询按钮添加事件监听器
        const searchButton = document.querySelector('#usersPage .btn-primary i.fa-search').closest('button');
        if (searchButton) {
            searchButton.addEventListener('click', function(e) {
                e.preventDefault();
                // 获取查询条件
                const username = document.querySelector('#usersPage input[placeholder="请输入用户名"]').value;
                const role = document.querySelector('#usersPage select').value;
                
                // 调用后端API查询用户
                loadUserList(1, username, role);
            });
        }
        
        // 添加用户按钮事件
        const addUserButton = document.getElementById('addUserBtn');
        if (addUserButton) {
            addUserButton.addEventListener('click', function() {
                // 清空表单
                document.getElementById('userForm').reset();
                // 特别清空用户ID字段
                document.getElementById('userId').value = '';
                // 设置默认值
                document.getElementById('status').value = '1';
                // 清空密码字段
                document.getElementById('password').value = '';
                // 显示模态框
                document.getElementById('modalTitle').textContent = '添加用户';
                document.getElementById('userModal').style.display = 'block';
            });
        }
        
        // 保存用户
        function saveUser() {
            const userId = document.getElementById('userId').value;
            const user = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                realName: document.getElementById('realName').value,
                role: document.getElementById('role').value,
                status: parseInt(document.getElementById('status').value)
            };
            
            let url = '/api/users';
            let method = 'POST';
            
            // 如果是更新操作
            if (userId && userId !== '') {
                user.id = parseInt(userId);
                method = 'PUT';
                // 更新时只在需要时发送密码
                const password = document.getElementById('password').value;
                if (password) {
                    user.password = password;
                }
            } else {
                // 新增用户使用注册接口，必须提供密码
                user.password = document.getElementById('password').value;
                url = '/api/users/register';
            }
            
            // 发送请求
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.code === 200) {
                    alert(userId ? '用户更新成功' : '用户添加成功');
                    closeUserModal();
                    // 重新加载用户列表
                    loadUserList(currentPage);
                } else {
                    const errorMessage = data.message || '未知错误';
                    alert((userId ? '更新' : '添加') + '用户失败: ' + errorMessage);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert((userId ? '更新' : '添加') + '用户失败: ' + (error.message || '网络错误'));
            });
        }
        
        // 关闭模态框
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            // 清空表单
            document.getElementById('userForm').reset();
            // 特别清空用户ID字段
            document.getElementById('userId').value = '';
            // 清空密码字段
            document.getElementById('password').value = '';
        }
        
        // 绑定模态框事件
        document.getElementById('closeModal').addEventListener('click', closeUserModal);
        document.getElementById('cancelBtn').addEventListener('click', closeUserModal);
        document.getElementById('saveUserBtn').addEventListener('click', saveUser);
        
        // 点击模态框外部关闭
        document.getElementById('userModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });
        
        // 当切换到用户管理页面时加载数据
        document.querySelector('[data-page="users"]').addEventListener('click', function() {
            loadUserList(1);
        });
        
        // 页面加载完成后尝试加载用户列表一次
        document.addEventListener('DOMContentLoaded', function() {
            // 如果当前页面是用户管理页面，则加载数据
            if (document.querySelector('[data-page="users"]') && document.querySelector('[data-page="users"]').classList.contains('active')) {
                loadUserList(1);
            }
        });
        
        // 医生管理功能
        let currentDoctorPage = 1;
        const doctorPageSize = 10;
        let currentSearchRealName = ''; // 保存当前搜索的医生姓名
        
        // 查询医生列表
        function loadDoctorList(page = 1, realName = '') {
            currentDoctorPage = page;
            // 如果没有传入realName参数，则使用当前保存的搜索条件
            if (arguments.length === 1) {
                realName = currentSearchRealName;
            } else {
                // 更新当前搜索条件
                currentSearchRealName = realName;
            }
            
            let url = `/api/doctors?page=${page}&size=${doctorPageSize}`;
            if (realName && realName.trim() !== '') {
                url += `&realName=${encodeURIComponent(realName.trim())}`;
            }
            
            console.log('正在请求医生列表:', url);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('收到医生列表响应:', data);
                    if (data.code === 200) {
                        updateDoctorTable(data.data.records);
                        updateDoctorPagination(data.data);
                    } else {
                        alert('获取医生列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取医生列表失败');
                });
        }
        
        // 更新医生表格
        function updateDoctorTable(doctors) {
            const tbody = document.querySelector('#doctorsPage tbody');
            tbody.innerHTML = '';
            
            doctors.forEach(doctor => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doctor.id || ''}</td>
                    <td>${doctor.userId || ''}</td>
                    <td>${doctor.hospital || ''}</td>
                    <td>${doctor.department || ''}</td>
                    <td>${doctor.title || ''}</td>
                    <td>${doctor.specialty || ''}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline view-doctor" data-id="${doctor.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline edit-doctor" data-id="${doctor.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger delete-doctor" data-id="${doctor.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 绑定事件
            bindDoctorActions();
        }
        
        // 更新医生分页信息
        function updateDoctorPagination(pageData) {
            const pageInfo = document.querySelector('#doctorsPage .page-info');
            const pageControls = document.querySelector('#doctorsPage .page-controls');
            const currentPageNum = document.querySelector('#doctorsPage #currentDoctorPageNum');
            const prevPageBtn = document.querySelector('#doctorsPage #prevDoctorPage');
            const nextPageBtn = document.querySelector('#doctorsPage #nextDoctorPage');
            
            // 计算总页数
            const totalPages = Math.ceil(pageData.total / pageData.pageSize);
            
            // 更新页面信息
            pageInfo.textContent = `显示 ${(pageData.currentPage - 1) * pageData.pageSize + 1} 到 ${Math.min(pageData.currentPage * pageData.pageSize, pageData.total)} 条记录，共 ${pageData.total} 条`;
            
            // 更新当前页码
            currentPageNum.textContent = pageData.currentPage;
            
            // 更新按钮状态
            prevPageBtn.disabled = pageData.currentPage <= 1;
            nextPageBtn.disabled = pageData.currentPage >= totalPages;
        }
        
        // 绑定医生操作事件
        function bindDoctorActions() {
            // 查看医生
            document.querySelectorAll('.view-doctor').forEach(btn => {
                btn.addEventListener('click', function() {
                    const doctorId = this.getAttribute('data-id');
                    viewDoctor(doctorId);
                });
            });
            
            // 编辑医生
            document.querySelectorAll('.edit-doctor').forEach(btn => {
                btn.addEventListener('click', function() {
                    const doctorId = this.getAttribute('data-id');
                    editDoctor(doctorId);
                });
            });
            
            // 删除医生
            document.querySelectorAll('.delete-doctor').forEach(btn => {
                btn.addEventListener('click', function() {
                    const doctorId = this.getAttribute('data-id');
                    deleteDoctor(doctorId);
                });
            });
        }
        
        // 查看医生详情
        function viewDoctor(doctorId) {
            fetch(`/api/doctors/${doctorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const doctor = data.data;
                        alert(`医生详情:
ID: ${doctor.id}
用户ID: ${doctor.userId}
医院: ${doctor.hospital || ''}
科室: ${doctor.department || ''}
职称: ${doctor.title || ''}
专长: ${doctor.specialty || ''}
简介: ${doctor.introduction || ''}`);
                    } else {
                        alert('获取医生详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取医生详情失败');
                });
        }
        
        // 编辑医生
        function editDoctor(doctorId) {
            fetch(`/api/doctors/${doctorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const doctor = data.data;
                        // 填充表单数据
                        document.getElementById('doctorId').value = doctor.id || '';
                        document.getElementById('doctorUserId').value = doctor.userId || '';
                        document.getElementById('doctorHospital').value = doctor.hospital || '';
                        document.getElementById('doctorDepartment').value = doctor.department || '';
                        document.getElementById('doctorTitle').value = doctor.title || '';
                        document.getElementById('doctorSpecialty').value = doctor.specialty || '';
                        document.getElementById('doctorIntroduction').value = doctor.introduction || '';
                        
                        // 显示模态框
                        document.getElementById('doctorModalTitle').textContent = '编辑医生';
                        document.getElementById('doctorModal').style.display = 'block';
                    } else {
                        alert('获取医生信息失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取医生信息失败');
                });
        }
        
        // 删除医生
        function deleteDoctor(doctorId) {
            if (confirm('确定要删除这个医生吗？')) {
                fetch(`/api/doctors/${doctorId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('医生删除成功');
                        // 重新加载医生列表
                        loadDoctorList(currentDoctorPage);
                    } else {
                        alert('删除医生失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除医生失败');
                });
            }
        }
        
        // 保存医生
        function saveDoctor() {
            const doctorId = document.getElementById('doctorId').value;
            const doctor = {
                userId: document.getElementById('doctorUserId').value,
                hospital: document.getElementById('doctorHospital').value,
                department: document.getElementById('doctorDepartment').value,
                title: document.getElementById('doctorTitle').value,
                specialty: document.getElementById('doctorSpecialty').value,
                introduction: document.getElementById('doctorIntroduction').value
            };
            
            let url = '/api/doctors';
            let method = 'POST';
            
            // 如果是更新操作
            if (doctorId && doctorId !== '') {
                doctor.id = parseInt(doctorId);
                method = 'PUT';
            }
            
            // 发送请求
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(doctor)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(doctorId ? '医生更新成功' : '医生添加成功');
                    closeDoctorModal();
                    // 重新加载医生列表
                    loadDoctorList(currentDoctorPage);
                } else {
                    alert((doctorId ? '更新' : '添加') + '医生失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert((doctorId ? '更新' : '添加') + '医生失败: ' + (error.message || '网络错误'));
            });
        }
        
        // 关闭医生模态框
        function closeDoctorModal() {
            document.getElementById('doctorModal').style.display = 'none';
            // 清空表单
            document.getElementById('doctorForm').reset();
            // 特别清空医生ID字段
            document.getElementById('doctorId').value = '';
        }
        
        // 添加医生按钮事件
        document.getElementById('addDoctorBtn').addEventListener('click', function() {
            // 清空表单
            document.getElementById('doctorForm').reset();
            // 特别清空医生ID字段
            document.getElementById('doctorId').value = '';
            // 显示模态框
            document.getElementById('doctorModalTitle').textContent = '添加医生';
            document.getElementById('doctorModal').style.display = 'block';
        });
        
        // 绑定医生模态框事件
        document.getElementById('closeDoctorModal').addEventListener('click', closeDoctorModal);
        document.getElementById('cancelDoctorBtn').addEventListener('click', closeDoctorModal);
        document.getElementById('saveDoctorBtn').addEventListener('click', saveDoctor);
        
        // 点击医生模态框外部关闭
        document.getElementById('doctorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDoctorModal();
            }
        });
        
        // 当切换到医生管理页面时加载数据
        document.querySelector('[data-page="doctors"]').addEventListener('click', function() {
            // 清空搜索条件
            document.getElementById('doctorRealName').value = '';
            currentSearchRealName = '';
            loadDoctorList(1);
        });
        
        // 绑定医生查询按钮事件
        document.getElementById('searchDoctorBtn').addEventListener('click', function() {
            const realName = document.getElementById('doctorRealName').value;
            loadDoctorList(1, realName);
        });
        
        // 绑定医生重置按钮事件
        document.getElementById('resetDoctorBtn').addEventListener('click', function() {
            document.getElementById('doctorRealName').value = '';
            currentSearchRealName = '';
            loadDoctorList(1);
        });
        
        // 绑定医生查询表单回车事件
        document.getElementById('doctorRealName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const realName = this.value;
                loadDoctorList(1, realName);
            }
        });

        // 预约管理功能
        let currentAppointmentPage = 1;
        const appointmentPageSize = 10;
        let currentAppointmentSearchUserRealName = ''; // 保存当前搜索的用户姓名
        
        // 查询预约列表
        function loadAppointmentList(page = 1, userRealName = '') {
            currentAppointmentPage = page;
            // 如果没有传入userRealName参数，则使用当前保存的搜索条件
            if (arguments.length === 1) {
                userRealName = currentAppointmentSearchUserRealName;
            } else {
                // 更新当前搜索条件
                currentAppointmentSearchUserRealName = userRealName;
            }
            
            let url = `/api/appointments?page=${page}&size=${appointmentPageSize}`;
            if (userRealName && userRealName.trim() !== '') {
                url += `&userRealName=${encodeURIComponent(userRealName.trim())}`;
            }
            
            console.log('正在请求预约列表:', url);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('收到预约列表响应:', data);
                    if (data.code === 200) {
                        updateAppointmentTable(data.data.records);
                        updateAppointmentPagination(data.data);
                    } else {
                        alert('获取预约列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取预约列表失败');
                });
        }
        
        // 更新预约表格
        function updateAppointmentTable(appointments) {
            const tbody = document.querySelector('#appointmentsPage tbody');
            tbody.innerHTML = '';
            
            appointments.forEach(appointment => {
                // 格式化预约时间
                const appointmentTime = appointment.appointmentTime ? 
                    new Date(appointment.appointmentTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';
                
                // 获取状态文本
                const statusText = getStatusText(appointment.status);
                const statusClass = getStatusClass(appointment.status);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${appointment.id || ''}</td>
                    <td>${appointment.userRealName || appointment.userName || ''}</td>
                    <td>${appointment.hospital || ''}</td>
                    <td>${appointment.department || ''}</td>
                    <td>${appointment.title || ''}</td>
                    <td>${appointmentTime}</td>
                    <td><span class="tag ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline view-appointment" data-id="${appointment.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger delete-appointment" data-id="${appointment.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 绑定事件
            bindAppointmentActions();
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                0: '待确认',
                1: '已确认',
                2: '已完成',
                3: '已取消'
            };
            return statusMap[status] || '未知';
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            const classMap = {
                0: 'tag-warning',
                1: 'tag-success',
                2: 'tag-info',
                3: 'tag-danger'
            };
            return classMap[status] || 'tag-default';
        }
        
        // 更新预约分页信息
        function updateAppointmentPagination(pageData) {
            const pageInfo = document.querySelector('#appointmentsPage .page-info');
            const pageControls = document.querySelector('#appointmentsPage .page-controls');
            const currentPageNum = document.querySelector('#appointmentsPage #currentAppointmentPageNum');
            const prevPageBtn = document.querySelector('#appointmentsPage #prevAppointmentPage');
            const nextPageBtn = document.querySelector('#appointmentsPage #nextAppointmentPage');
            
            // 计算总页数
            const totalPages = Math.ceil(pageData.total / pageData.pageSize);
            
            // 更新页面信息
            pageInfo.textContent = `显示 ${(pageData.currentPage - 1) * pageData.pageSize + 1} 到 ${Math.min(pageData.currentPage * pageData.pageSize, pageData.total)} 条记录，共 ${pageData.total} 条`;
            
            // 更新当前页码
            currentPageNum.textContent = pageData.currentPage;
            
            // 更新按钮状态
            prevPageBtn.disabled = pageData.currentPage <= 1;
            nextPageBtn.disabled = pageData.currentPage >= totalPages;
        }
        
        // 绑定预约操作事件
        function bindAppointmentActions() {
            // 查看预约
            document.querySelectorAll('.view-appointment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const appointmentId = this.getAttribute('data-id');
                    viewAppointment(appointmentId);
                });
            });
            
            // 删除预约
            document.querySelectorAll('.delete-appointment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const appointmentId = this.getAttribute('data-id');
                    deleteAppointment(appointmentId);
                });
            });
        }
        
        // 查看预约详情
        function viewAppointment(appointmentId) {
            fetch(`/api/appointments/${appointmentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const appointment = data.data;
                        // 格式化预约时间
                        const appointmentTime = appointment.appointmentTime ? 
                            new Date(appointment.appointmentTime).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        
                        // 获取状态文本
                        const statusText = getStatusText(appointment.status);
                        
                        alert(`预约详情:
ID: ${appointment.id}
用户: ${appointment.userRealName || appointment.userName || ''}
医院: ${appointment.hospital || ''}
科室: ${appointment.department || ''}
医生职称: ${appointment.title || ''}
预约时间: ${appointmentTime}
状态: ${statusText}
备注: ${appointment.remark || ''}`);
                    } else {
                        alert('获取预约详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取预约详情失败');
                });
        }
        
        // 删除预约
        function deleteAppointment(appointmentId) {
            if (confirm('确定要删除这个预约吗？')) {
                fetch(`/api/appointments/${appointmentId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('预约删除成功');
                        // 重新加载预约列表
                        loadAppointmentList(currentAppointmentPage);
                    } else {
                        alert('删除预约失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除预约失败');
                });
            }
        }
        
        // 当切换到预约管理页面时加载数据
        document.querySelector('[data-page="appointments"]').addEventListener('click', function() {
            // 清空搜索条件
            document.getElementById('appointmentUserRealName').value = '';
            currentAppointmentSearchUserRealName = '';
            loadAppointmentList(1);
        });
        
        // 绑定预约查询按钮事件
        document.getElementById('searchAppointmentBtn').addEventListener('click', function() {
            const userRealName = document.getElementById('appointmentUserRealName').value;
            loadAppointmentList(1, userRealName);
        });
        
        // 绑定预约重置按钮事件
        document.getElementById('resetAppointmentBtn').addEventListener('click', function() {
            document.getElementById('appointmentUserRealName').value = '';
            currentAppointmentSearchUserRealName = '';
            loadAppointmentList(1);
        });
        
        // 绑定预约查询表单回车事件
        document.getElementById('appointmentUserRealName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const userRealName = this.value;
                loadAppointmentList(1, userRealName);
            }
        });

        // 知识管理功能
        let currentKnowledgePage = 1;
        const knowledgePageSize = 10;
        let currentKnowledgeSearchTitle = ''; // 保存当前搜索的标题
        
        // 查询知识列表
        function loadKnowledgeList(page = 1, title = '') {
            currentKnowledgePage = page;
            // 如果没有传入title参数，则使用当前保存的搜索条件
            if (arguments.length === 1) {
                title = currentKnowledgeSearchTitle;
            } else {
                // 更新当前搜索条件
                currentKnowledgeSearchTitle = title;
            }
            
            let url = `/api/knowledge?page=${page}&size=${knowledgePageSize}`;
            if (title && title.trim() !== '') {
                url += `&title=${encodeURIComponent(title.trim())}`;
            }
            
            console.log('正在请求知识列表:', url);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('收到知识列表响应:', data);
                    if (data.code === 200) {
                        updateKnowledgeTable(data.data.records);
                        updateKnowledgePagination(data.data);
                    } else {
                        alert('获取知识列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取知识列表失败');
                });
        }
        
        // 更新知识表格
        function updateKnowledgeTable(knowledgeList) {
            const tbody = document.querySelector('#knowledgePage tbody');
            tbody.innerHTML = '';
            
            knowledgeList.forEach(knowledge => {
                // 格式化创建时间
                const createdTime = knowledge.createdTime ? 
                    new Date(knowledge.createdTime).toLocaleDateString('zh-CN') : '';
                
                // 获取状态文本
                const statusText = knowledge.status === 1 ? '已发布' : '未发布';
                const statusClass = knowledge.status === 1 ? 'tag-success' : 'tag-warning';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${knowledge.id || ''}</td>
                    <td>${knowledge.title || ''}</td>
                    <td>${knowledge.category || ''}</td>
                    <td><span class="tag ${statusClass}">${statusText}</span></td>
                    <td>${createdTime}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline view-knowledge" data-id="${knowledge.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline edit-knowledge" data-id="${knowledge.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger delete-knowledge" data-id="${knowledge.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 绑定事件
            bindKnowledgeActions();
        }
        
        // 更新知识分页信息
        function updateKnowledgePagination(pageData) {
            const pageInfo = document.querySelector('#knowledgePage .page-info');
            const pageControls = document.querySelector('#knowledgePage .page-controls');
            const currentPageNum = document.querySelector('#knowledgePage #currentKnowledgePageNum');
            const prevPageBtn = document.querySelector('#knowledgePage #prevKnowledgePage');
            const nextPageBtn = document.querySelector('#knowledgePage #nextKnowledgePage');
            
            // 计算总页数
            const totalPages = Math.ceil(pageData.total / pageData.pageSize);
            
            // 更新页面信息
            pageInfo.textContent = `显示 ${(pageData.currentPage - 1) * pageData.pageSize + 1} 到 ${Math.min(pageData.currentPage * pageData.pageSize, pageData.total)} 条记录，共 ${pageData.total} 条`;
            
            // 更新当前页码
            currentPageNum.textContent = pageData.currentPage;
            
            // 更新按钮状态
            prevPageBtn.disabled = pageData.currentPage <= 1;
            nextPageBtn.disabled = pageData.currentPage >= totalPages;
        }
        
        // 绑定知识操作事件
        function bindKnowledgeActions() {
            // 查看知识
            document.querySelectorAll('.view-knowledge').forEach(btn => {
                btn.addEventListener('click', function() {
                    const knowledgeId = this.getAttribute('data-id');
                    viewKnowledge(knowledgeId);
                });
            });
            
            // 编辑知识
            document.querySelectorAll('.edit-knowledge').forEach(btn => {
                btn.addEventListener('click', function() {
                    const knowledgeId = this.getAttribute('data-id');
                    editKnowledge(knowledgeId);
                });
            });
            
            // 删除知识
            document.querySelectorAll('.delete-knowledge').forEach(btn => {
                btn.addEventListener('click', function() {
                    const knowledgeId = this.getAttribute('data-id');
                    deleteKnowledge(knowledgeId);
                });
            });
        }
        
        // 查看知识详情
        function viewKnowledge(knowledgeId) {
            fetch(`/api/knowledge/${knowledgeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const knowledge = data.data;
                        // 格式化创建时间
                        const createdTime = knowledge.createdTime ? 
                            new Date(knowledge.createdTime).toLocaleString('zh-CN') : '';
                        
                        // 格式化更新时间
                        const updatedTime = knowledge.updatedTime ? 
                            new Date(knowledge.updatedTime).toLocaleString('zh-CN') : '';
                        
                        alert(`知识详情:
ID: ${knowledge.id}
标题: ${knowledge.title || ''}
分类: ${knowledge.category || ''}
状态: ${knowledge.status === 1 ? '已发布' : '未发布'}
创建时间: ${createdTime}
更新时间: ${updatedTime}
内容: ${knowledge.content || ''}`);
                    } else {
                        alert('获取知识详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取知识详情失败');
                });
        }
        
        // 编辑知识
        function editKnowledge(knowledgeId) {
            fetch(`/api/knowledge/${knowledgeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const knowledge = data.data;
                        // 填充表单数据到知识编辑模态框
                        showKnowledgeModal(knowledge);
                    } else {
                        alert('获取知识信息失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取知识信息失败');
                });
        }
        
        // 删除知识
        function deleteKnowledge(knowledgeId) {
            if (confirm('确定要删除这个知识吗？')) {
                fetch(`/api/knowledge/${knowledgeId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('知识删除成功');
                        // 重新加载知识列表
                        loadKnowledgeList(currentKnowledgePage);
                    } else {
                        alert('删除知识失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除知识失败');
                });
            }
        }
        
        // 显示知识编辑模态框
        function showKnowledgeModal(knowledge = null) {
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal" id="knowledgeModal" style="display: block;">
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <h3 id="knowledgeModalTitle">${knowledge ? '编辑知识' : '发布知识'}</h3>
                            <button class="btn btn-outline" id="closeKnowledgeModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="knowledgeForm">
                                <input type="hidden" id="knowledgeId" value="${knowledge ? knowledge.id : ''}">
                                <div class="form-group">
                                    <label>标题</label>
                                    <input type="text" class="form-control" id="knowledgeTitleInput" value="${knowledge ? knowledge.title || '' : ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>分类</label>
                                    <input type="text" class="form-control" id="knowledgeCategory" value="${knowledge ? knowledge.category || '' : ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>状态</label>
                                    <select class="form-control" id="knowledgeStatus">
                                        <option value="1" ${knowledge && knowledge.status === 1 ? 'selected' : ''}>已发布</option>
                                        <option value="0" ${knowledge && knowledge.status === 0 ? 'selected' : ''}>未发布</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>内容</label>
                                    <textarea class="form-control" id="knowledgeContent" rows="5">${knowledge ? knowledge.content || '' : ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelKnowledgeBtn">取消</button>
                            <button class="btn btn-primary" id="saveKnowledgeBtn">保存</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加模态框到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 绑定事件
            document.getElementById('closeKnowledgeModal').addEventListener('click', closeKnowledgeModal);
            document.getElementById('cancelKnowledgeBtn').addEventListener('click', closeKnowledgeModal);
            document.getElementById('saveKnowledgeBtn').addEventListener('click', saveKnowledge);
            
            // 点击模态框外部关闭
            document.getElementById('knowledgeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeKnowledgeModal();
                }
            });
        }
        
        // 关闭知识模态框
        function closeKnowledgeModal() {
            const modal = document.getElementById('knowledgeModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 保存知识
        function saveKnowledge() {
            const knowledgeId = document.getElementById('knowledgeId').value;
            const knowledge = {
                title: document.getElementById('knowledgeTitleInput').value,
                category: document.getElementById('knowledgeCategory').value,
                status: parseInt(document.getElementById('knowledgeStatus').value),
                content: document.getElementById('knowledgeContent').value
            };
            
            let url = '/api/knowledge';
            let method = 'POST';
            
            // 如果是更新操作
            if (knowledgeId && knowledgeId !== '') {
                knowledge.id = parseInt(knowledgeId);
                method = 'PUT';
            }
            
            // 发送请求
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(knowledge)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(knowledgeId ? '知识更新成功' : '知识发布成功');
                    closeKnowledgeModal();
                    // 重新加载知识列表
                    loadKnowledgeList(currentKnowledgePage);
                } else {
                    alert((knowledgeId ? '更新' : '发布') + '知识失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert((knowledgeId ? '更新' : '发布') + '知识失败: ' + (error.message || '网络错误'));
            });
        }
        
        // 当切换到知识管理页面时加载数据
        document.querySelector('[data-page="knowledge"]').addEventListener('click', function() {
            // 清空搜索条件
            document.getElementById('knowledgeTitle').value = '';
            currentKnowledgeSearchTitle = '';
            loadKnowledgeList(1);
        });
        
        // 绑定知识查询按钮事件
        document.getElementById('searchKnowledgeBtn').addEventListener('click', function() {
            const title = document.getElementById('knowledgeTitle').value;
            loadKnowledgeList(1, title);
        });
        
        // 绑定知识重置按钮事件
        document.getElementById('resetKnowledgeBtn').addEventListener('click', function() {
            document.getElementById('knowledgeTitle').value = '';
            currentKnowledgeSearchTitle = '';
            loadKnowledgeList(1);
        });
        
        // 绑定知识查询表单回车事件
        document.getElementById('knowledgeTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const title = this.value;
                loadKnowledgeList(1, title);
            }
        });
        
        // 添加知识按钮事件
        document.getElementById('addKnowledgeBtn').addEventListener('click', function() {
            showKnowledgeModal();
        });

        // 咨询管理功能
        let currentConsultationPage = 1;
        const consultationPageSize = 10;
        let currentConsultationSearchTitle = ''; // 保存当前搜索的标题
        let currentConsultationSearchStatus = ''; // 保存当前搜索的状态
        
        // 查询咨询列表
        function loadConsultationList(page = 1, title = '', status = '') {
            currentConsultationPage = page;
            // 如果没有传入参数，则使用当前保存的搜索条件
            if (arguments.length === 1) {
                title = currentConsultationSearchTitle;
                status = currentConsultationSearchStatus;
            } else {
                // 更新当前搜索条件
                currentConsultationSearchTitle = title;
                currentConsultationSearchStatus = status;
            }
            
            let url = `/api/consultations?page=${page}&size=${consultationPageSize}`;
            if (title && title.trim() !== '') {
                url += `&title=${encodeURIComponent(title.trim())}`;
            }
            if (status !== '') {
                url += `&status=${status}`;
            }
            
            console.log('正在请求咨询列表:', url);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('收到咨询列表响应:', data);
                    if (data.code === 200) {
                        updateConsultationTable(data.data.records);
                        updateConsultationPagination(data.data);
                    } else {
                        alert('获取咨询列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取咨询列表失败');
                });
        }
        
        // 更新咨询表格
        function updateConsultationTable(consultations) {
            const tbody = document.querySelector('#consultationsPage tbody');
            tbody.innerHTML = '';
            
            consultations.forEach(consultation => {
                // 格式化创建时间
                const createdTime = consultation.createdTime ? 
                    new Date(consultation.createdTime).toLocaleDateString('zh-CN') : '';
                
                // 获取状态文本
                const statusText = consultation.status === 1 ? '已回复' : '未回复';
                const statusClass = consultation.status === 1 ? 'tag-success' : 'tag-warning';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${consultation.id || ''}</td>
                    <td>${consultation.userName || ''}</td>
                    <td>${consultation.title || ''}</td>
                    <td><span class="tag ${statusClass}">${statusText}</span></td>
                    <td>${createdTime}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline view-consultation" data-id="${consultation.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline reply-consultation" data-id="${consultation.id}">
                                <i class="fas fa-reply"></i>
                            </button>
                            <button class="btn btn-danger delete-consultation" data-id="${consultation.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 绑定事件
            bindConsultationActions();
        }
        
        // 更新咨询分页信息
        function updateConsultationPagination(pageData) {
            const pageInfo = document.querySelector('#consultationsPage .page-info');
            const pageControls = document.querySelector('#consultationsPage .page-controls');
            const currentPageNum = document.querySelector('#consultationsPage #currentConsultationPageNum');
            const prevPageBtn = document.querySelector('#consultationsPage #prevConsultationPage');
            const nextPageBtn = document.querySelector('#consultationsPage #nextConsultationPage');
            
            // 计算总页数
            const totalPages = Math.ceil(pageData.total / pageData.pageSize);
            
            // 更新页面信息
            pageInfo.textContent = `显示 ${(pageData.currentPage - 1) * pageData.pageSize + 1} 到 ${Math.min(pageData.currentPage * pageData.pageSize, pageData.total)} 条记录，共 ${pageData.total} 条`;
            
            // 更新当前页码
            currentPageNum.textContent = pageData.currentPage;
            
            // 更新按钮状态
            prevPageBtn.disabled = pageData.currentPage <= 1;
            nextPageBtn.disabled = pageData.currentPage >= totalPages;
        }
        
        // 绑定咨询操作事件
        function bindConsultationActions() {
            // 查看咨询
            document.querySelectorAll('.view-consultation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const consultationId = this.getAttribute('data-id');
                    viewConsultation(consultationId);
                });
            });
            
            // 回复咨询
            document.querySelectorAll('.reply-consultation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const consultationId = this.getAttribute('data-id');
                    replyConsultation(consultationId);
                });
            });
            
            // 删除咨询
            document.querySelectorAll('.delete-consultation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const consultationId = this.getAttribute('data-id');
                    deleteConsultation(consultationId);
                });
            });
        }
        
        // 查看咨询详情
        function viewConsultation(consultationId) {
            fetch(`/api/consultations/${consultationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const consultation = data.data;
                        // 格式化创建时间
                        const createdTime = consultation.createdTime ? 
                            new Date(consultation.createdTime).toLocaleString('zh-CN') : '';
                        
                        // 格式化回复时间
                        const repliedTime = consultation.repliedTime ? 
                            new Date(consultation.repliedTime).toLocaleString('zh-CN') : '';
                        
                        alert(`咨询详情:
ID: ${consultation.id}
用户: ${consultation.userName || ''}
标题: ${consultation.title || ''}
状态: ${consultation.status === 1 ? '已回复' : '未回复'}
创建时间: ${createdTime}
回复时间: ${repliedTime}
内容: ${consultation.content || ''}
回复: ${consultation.reply || ''}`);
                    } else {
                        alert('获取咨询详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取咨询详情失败');
                });
        }
        
        // 回复咨询
        function replyConsultation(consultationId) {
            fetch(`/api/consultations/${consultationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const consultation = data.data;
                        // 显示回复模态框
                        showReplyModal(consultation);
                    } else {
                        alert('获取咨询信息失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取咨询信息失败');
                });
        }
        
        // 显示回复模态框
        function showReplyModal(consultation) {
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal" id="replyModal" style="display: block;">
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <h3>回复咨询</h3>
                            <button class="btn btn-outline" id="closeReplyModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="replyForm">
                                <div class="form-group">
                                    <label>咨询标题</label>
                                    <input type="text" class="form-control" value="${consultation.title || ''}" disabled>
                                </div>
                                <div class="form-group">
                                    <label>咨询内容</label>
                                    <textarea class="form-control" rows="3" disabled>${consultation.content || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label>回复内容</label>
                                    <textarea class="form-control" id="replyContent" rows="5">${consultation.reply || ''}</textarea>
                                </div>
                                <input type="hidden" id="consultationId" value="${consultation.id}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelReplyBtn">取消</button>
                            <button class="btn btn-primary" id="sendReplyBtn">发送回复</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加模态框到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 绑定事件
            document.getElementById('closeReplyModal').addEventListener('click', closeReplyModal);
            document.getElementById('cancelReplyBtn').addEventListener('click', closeReplyModal);
            document.getElementById('sendReplyBtn').addEventListener('click', sendReply);
            
            // 点击模态框外部关闭
            document.getElementById('replyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReplyModal();
                }
            });
        }
        
        // 关闭回复模态框
        function closeReplyModal() {
            const modal = document.getElementById('replyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 发送回复
        function sendReply() {
            const consultationId = document.getElementById('consultationId').value;
            const replyContent = document.getElementById('replyContent').value;
            
            // 发送回复请求
            fetch(`/api/consultations/${consultationId}/reply`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reply: replyContent })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('回复成功');
                    closeReplyModal();
                    // 重新加载咨询列表
                    loadConsultationList(currentConsultationPage);
                } else {
                    alert('回复失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('回复失败: ' + (error.message || '网络错误'));
            });
        }
        
        // 删除咨询
        function deleteConsultation(consultationId) {
            if (confirm('确定要删除这个咨询吗？')) {
                fetch(`/api/consultations/${consultationId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('咨询删除成功');
                        // 重新加载咨询列表
                        loadConsultationList(currentConsultationPage);
                    } else {
                        alert('删除咨询失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除咨询失败');
                });
            }
        }
        
        // 当切换到咨询管理页面时加载数据
        document.querySelector('[data-page="consultations"]').addEventListener('click', function() {
            // 清空搜索条件
            document.getElementById('consultationTitle').value = '';
            document.getElementById('consultationStatus').value = '';
            currentConsultationSearchTitle = '';
            currentConsultationSearchStatus = '';
            loadConsultationList(1);
        });
        
        // 绑定咨询查询按钮事件
        document.getElementById('searchConsultationBtn').addEventListener('click', function() {
            const title = document.getElementById('consultationTitle').value;
            const status = document.getElementById('consultationStatus').value;
            loadConsultationList(1, title, status);
        });
        
        // 绑定咨询重置按钮事件
        document.getElementById('resetConsultationBtn').addEventListener('click', function() {
            document.getElementById('consultationTitle').value = '';
            document.getElementById('consultationStatus').value = '';
            currentConsultationSearchTitle = '';
            currentConsultationSearchStatus = '';
            loadConsultationList(1);
        });
        
        // 绑定咨询查询表单回车事件
        document.getElementById('consultationTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const title = this.value;
                const status = document.getElementById('consultationStatus').value;
                loadConsultationList(1, title, status);
            }
        });

    </script>
</body>
</html>