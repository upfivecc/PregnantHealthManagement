<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孕妇健康管理系统 - 预约管理</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/admin.css">
</head>
<body>
    <div class="page fade-in" id="appointmentsPage">
        <div class="card">
            <div class="card-header">
                <div class="card-title">预约管理</div>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                <form class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>用户姓名:</label>
                            <input type="text" id="appointmentUserName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>医生姓名:</label>
                            <input type="text" id="appointmentDoctorName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>状态:</label>
                            <select id="appointmentStatus" class="form-control">
                                <option value="">全部</option>
                                <option value="0">待确认</option>
                                <option value="1">已确认</option>
                                <option value="2">已完成</option>
                                <option value="3">已取消</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="searchAppointmentBtn">
                                <i class="fas fa-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-outline" id="resetAppointmentBtn">
                                <i class="fas fa-redo"></i> 重置
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- 预约表格 -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户</th>
                                <th>医生</th>
                                <th>预约时间</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="pagination" id="appointmentPagination">
                    <button class="btn btn-outline" id="prevAppointmentPage"><i class="fas fa-chevron-left"></i></button>
                    <span id="appointmentPageInfo">第 1 页，共 1 页</span>
                    <button class="btn btn-outline" id="nextAppointmentPage"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预约详情模态框 -->
    <div class="modal" id="appointmentDetailModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>预约详情</h3>
                <button class="btn btn-outline" id="closeAppointmentDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="appointmentDetailContent">
                    <!-- 详情内容将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelAppointmentDetailBtn">关闭</button>
            </div>
        </div>
    </div>

    <script src="./lib/js/vue.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script src="./js/main.js"></script>
    <script>
        // 全局变量
        let currentAppointmentPage = 1;
        let currentAppointmentSearchUserName = '';
        let currentAppointmentSearchDoctorName = '';
        let currentAppointmentSearchStatus = '';
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载预约列表
            loadAppointmentList(1);
            
            // 绑定事件
            bindAppointmentEvents();
        });
        
        // 绑定预约相关事件
        function bindAppointmentEvents() {
            // 预约查询按钮
            document.getElementById('searchAppointmentBtn').addEventListener('click', function() {
                currentAppointmentSearchUserName = document.getElementById('appointmentUserName').value;
                currentAppointmentSearchDoctorName = document.getElementById('appointmentDoctorName').value;
                currentAppointmentSearchStatus = document.getElementById('appointmentStatus').value;
                loadAppointmentList(1);
            });
            
            // 预约重置按钮
            document.getElementById('resetAppointmentBtn').addEventListener('click', function() {
                document.getElementById('appointmentUserName').value = '';
                document.getElementById('appointmentDoctorName').value = '';
                document.getElementById('appointmentStatus').value = '';
                currentAppointmentSearchUserName = '';
                currentAppointmentSearchDoctorName = '';
                currentAppointmentSearchStatus = '';
                loadAppointmentList(1);
            });
            
            // 上一页按钮
            document.getElementById('prevAppointmentPage').addEventListener('click', function() {
                if (currentAppointmentPage > 1) {
                    loadAppointmentList(currentAppointmentPage - 1);
                }
            });
            
            // 下一页按钮
            document.getElementById('nextAppointmentPage').addEventListener('click', function() {
                loadAppointmentList(currentAppointmentPage + 1);
            });
            
            // 关闭预约详情模态框按钮
            document.getElementById('closeAppointmentDetailModal').addEventListener('click', function() {
                document.getElementById('appointmentDetailModal').style.display = 'none';
            });
            
            // 关闭预约详情模态框按钮
            document.getElementById('cancelAppointmentDetailBtn').addEventListener('click', function() {
                document.getElementById('appointmentDetailModal').style.display = 'none';
            });
        }
        
        // 加载预约列表
        function loadAppointmentList(page, userName = '', doctorName = '', status = '') {
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('size', 10);
            
            if (userName || currentAppointmentSearchUserName) {
                params.append('userName', userName || currentAppointmentSearchUserName);
            }
            if (doctorName || currentAppointmentSearchDoctorName) {
                params.append('doctorName', doctorName || currentAppointmentSearchDoctorName);
            }
            if (status || currentAppointmentSearchStatus) {
                params.append('status', status || currentAppointmentSearchStatus);
            }
            
            axios.get(`/api/appointments/page?${params.toString()}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const data = response.data.data;
                        renderAppointmentTable(data.records);
                        updateAppointmentPagination(data);
                        currentAppointmentPage = data.current;
                    } else {
                        alert('加载预约列表失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('加载预约列表失败');
                });
        }
        
        // 渲染预约表格
        function renderAppointmentTable(appointments) {
            const tbody = document.getElementById('appointmentTableBody');
            tbody.innerHTML = '';
            
            if (!appointments || appointments.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="7" class="text-center">暂无数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            appointments.forEach(appointment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${appointment.id || ''}</td>
                    <td>${appointment.userName || ''}</td>
                    <td>${appointment.doctorName || ''}</td>
                    <td>${formatDate(appointment.appointmentTime) || ''}</td>
                    <td>${getAppointmentStatusName(appointment.status) || ''}</td>
                    <td>${formatDate(appointment.createTime) || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewAppointment(${appointment.id})">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="confirmAppointment(${appointment.id})" ${appointment.status != 0 ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> 确认
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="cancelAppointment(${appointment.id})" ${appointment.status == 2 || appointment.status == 3 ? 'disabled' : ''}>
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 更新分页信息
        function updateAppointmentPagination(pageInfo) {
            document.getElementById('appointmentPageInfo').textContent = 
                `第 ${pageInfo.current} 页，共 ${pageInfo.pages} 页`;
            
            // 禁用/启用分页按钮
            document.getElementById('prevAppointmentPage').disabled = pageInfo.current === 1;
            document.getElementById('nextAppointmentPage').disabled = pageInfo.current === pageInfo.pages;
        }
        
        // 查看预约详情
        function viewAppointment(appointmentId) {
            axios.get(`/api/appointments/${appointmentId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const appointment = response.data.data;
                        const detailContent = document.getElementById('appointmentDetailContent');
                        detailContent.innerHTML = `
                            <div class="detail-item">
                                <label>ID:</label>
                                <span>${appointment.id || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>用户:</label>
                                <span>${appointment.userName || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>医生:</label>
                                <span>${appointment.doctorName || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>预约时间:</label>
                                <span>${formatDate(appointment.appointmentTime) || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>状态:</label>
                                <span>${getAppointmentStatusName(appointment.status) || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>创建时间:</label>
                                <span>${formatDate(appointment.createTime) || ''}</span>
                            </div>
                            <div class="detail-item">
                                <label>备注:</label>
                                <span>${appointment.remark || ''}</span>
                            </div>
                        `;
                        document.getElementById('appointmentDetailModal').style.display = 'block';
                    } else {
                        alert('获取预约详情失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取预约详情失败');
                });
        }
        
        // 确认预约
        function confirmAppointment(appointmentId) {
            if (confirm('确定要确认这个预约吗？')) {
                axios.put(`/api/appointments/${appointmentId}/confirm`)
                    .then(response => {
                        if (response.data.code === 200) {
                            alert('确认成功');
                            loadAppointmentList(currentAppointmentPage);
                        } else {
                            alert('确认失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('确认失败');
                    });
            }
        }
        
        // 取消预约
        function cancelAppointment(appointmentId) {
            if (confirm('确定要取消这个预约吗？')) {
                axios.put(`/api/appointments/${appointmentId}/cancel`)
                    .then(response => {
                        if (response.data.code === 200) {
                            alert('取消成功');
                            loadAppointmentList(currentAppointmentPage);
                        } else {
                            alert('取消失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('取消失败');
                    });
            }
        }
        
        // 获取预约状态名称
        function getAppointmentStatusName(status) {
            switch (status) {
                case 0: return '待确认';
                case 1: return '已确认';
                case 2: return '已完成';
                case 3: return '已取消';
                default: return '';
            }
        }
    </script>
</body>
</html>