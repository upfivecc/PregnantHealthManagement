<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孕妇健康管理系统 - 医生管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/admin.css">
</head>
<body>
    <div class="page fade-in" id="doctorsPage">
        <div class="card">
            <div class="card-header">
                <div class="card-title">医生管理</div>
                <div class="card-actions">
                    <button class="btn btn-primary" id="addDoctorBtn">
                        <i class="fas fa-plus"></i> 添加医生
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                <form class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>姓名:</label>
                            <input type="text" id="doctorName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>科室:</label>
                            <input type="text" id="doctorDepartment" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>职称:</label>
                            <select id="doctorTitle" class="form-control">
                                <option value="">全部</option>
                                <option value="主任医师">主任医师</option>
                                <option value="副主任医师">副主任医师</option>
                                <option value="主治医师">主治医师</option>
                                <option value="住院医师">住院医师</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="searchDoctorBtn">
                                <i class="fas fa-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-outline" id="resetDoctorBtn">
                                <i class="fas fa-redo"></i> 重置
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- 医生表格 -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>年龄</th>
                                <th>科室</th>
                                <th>职称</th>
                                <th>电话</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="doctorTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="pagination" id="doctorPagination">
                    <button class="btn btn-outline" id="prevDoctorPage"><i class="fas fa-chevron-left"></i></button>
                    <span id="doctorPageInfo">第 1 页，共 1 页</span>
                    <button class="btn btn-outline" id="nextDoctorPage"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 医生编辑模态框 -->
    <div class="modal" id="doctorModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="doctorModalTitle">编辑医生</h3>
                <button class="btn btn-outline" id="closeDoctorModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="doctorForm">
                    <input type="hidden" id="doctorId">
                    <div class="form-group">
                        <label>姓名:</label>
                        <input type="text" id="modalDoctorName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>性别:</label>
                        <select id="modalDoctorGender" class="form-control" required>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>年龄:</label>
                        <input type="number" id="modalDoctorAge" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>科室:</label>
                        <input type="text" id="modalDoctorDepartment" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>职称:</label>
                        <select id="modalDoctorTitle" class="form-control" required>
                            <option value="主任医师">主任医师</option>
                            <option value="副主任医师">副主任医师</option>
                            <option value="主治医师">主治医师</option>
                            <option value="住院医师">住院医师</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>电话:</label>
                        <input type="text" id="modalDoctorPhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>简介:</label>
                        <textarea id="modalDoctorIntroduction" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelDoctorBtn">取消</button>
                <button class="btn btn-primary" id="saveDoctorBtn">保存</button>
            </div>
        </div>
    </div>

    <script src="./lib/js/vue.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script src="./js/main.js"></script>
    <script>
        // 全局变量
        let currentDoctorPage = 1;
        let currentDoctorSearchName = '';
        let currentDoctorSearchDepartment = '';
        let currentDoctorSearchTitle = '';
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载医生列表
            loadDoctorList(1);
            
            // 绑定事件
            bindDoctorEvents();
        });
        
        // 绑定医生相关事件
        function bindDoctorEvents() {
            // 添加医生按钮
            document.getElementById('addDoctorBtn').addEventListener('click', function() {
                // 清空表单
                document.getElementById('doctorForm').reset();
                document.getElementById('doctorId').value = '';
                document.getElementById('doctorModalTitle').textContent = '添加医生';
                document.getElementById('doctorModal').style.display = 'block';
            });
            
            // 关闭模态框按钮
            document.getElementById('closeDoctorModal').addEventListener('click', function() {
                document.getElementById('doctorModal').style.display = 'none';
            });
            
            // 取消按钮
            document.getElementById('cancelDoctorBtn').addEventListener('click', function() {
                document.getElementById('doctorModal').style.display = 'none';
            });
            
            // 保存医生按钮
            document.getElementById('saveDoctorBtn').addEventListener('click', function() {
                saveDoctor();
            });
            
            // 医生查询按钮
            document.getElementById('searchDoctorBtn').addEventListener('click', function() {
                currentDoctorSearchName = document.getElementById('doctorName').value;
                currentDoctorSearchDepartment = document.getElementById('doctorDepartment').value;
                currentDoctorSearchTitle = document.getElementById('doctorTitle').value;
                loadDoctorList(1);
            });
            
            // 医生重置按钮
            document.getElementById('resetDoctorBtn').addEventListener('click', function() {
                document.getElementById('doctorName').value = '';
                document.getElementById('doctorDepartment').value = '';
                document.getElementById('doctorTitle').value = '';
                currentDoctorSearchName = '';
                currentDoctorSearchDepartment = '';
                currentDoctorSearchTitle = '';
                loadDoctorList(1);
            });
            
            // 上一页按钮
            document.getElementById('prevDoctorPage').addEventListener('click', function() {
                if (currentDoctorPage > 1) {
                    loadDoctorList(currentDoctorPage - 1);
                }
            });
            
            // 下一页按钮
            document.getElementById('nextDoctorPage').addEventListener('click', function() {
                loadDoctorList(currentDoctorPage + 1);
            });
        }
        
        // 加载医生列表
        function loadDoctorList(page, name = '', department = '', title = '') {
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('size', 10);
            
            if (name || currentDoctorSearchName) {
                params.append('name', name || currentDoctorSearchName);
            }
            if (department || currentDoctorSearchDepartment) {
                params.append('department', department || currentDoctorSearchDepartment);
            }
            if (title || currentDoctorSearchTitle) {
                params.append('title', title || currentDoctorSearchTitle);
            }
            
            axios.get(`/api/doctors/page?${params.toString()}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const data = response.data.data;
                        renderDoctorTable(data.records);
                        updateDoctorPagination(data);
                        currentDoctorPage = data.current;
                    } else {
                        alert('加载医生列表失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('加载医生列表失败');
                });
        }
        
        // 渲染医生表格
        function renderDoctorTable(doctors) {
            const tbody = document.getElementById('doctorTableBody');
            tbody.innerHTML = '';
            
            if (!doctors || doctors.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" class="text-center">暂无数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            doctors.forEach(doctor => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${doctor.id || ''}</td>
                    <td>${doctor.name || ''}</td>
                    <td>${doctor.gender || ''}</td>
                    <td>${doctor.age || ''}</td>
                    <td>${doctor.department || ''}</td>
                    <td>${doctor.title || ''}</td>
                    <td>${doctor.phone || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editDoctor(${doctor.id})">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDoctor(${doctor.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 更新分页信息
        function updateDoctorPagination(pageInfo) {
            document.getElementById('doctorPageInfo').textContent = 
                `第 ${pageInfo.current} 页，共 ${pageInfo.pages} 页`;
            
            // 禁用/启用分页按钮
            document.getElementById('prevDoctorPage').disabled = pageInfo.current === 1;
            document.getElementById('nextDoctorPage').disabled = pageInfo.current === pageInfo.pages;
        }
        
        // 编辑医生
        function editDoctor(doctorId) {
            axios.get(`/api/doctors/${doctorId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const doctor = response.data.data;
                        document.getElementById('doctorId').value = doctor.id;
                        document.getElementById('modalDoctorName').value = doctor.name;
                        document.getElementById('modalDoctorGender').value = doctor.gender;
                        document.getElementById('modalDoctorAge').value = doctor.age;
                        document.getElementById('modalDoctorDepartment').value = doctor.department;
                        document.getElementById('modalDoctorTitle').value = doctor.title;
                        document.getElementById('modalDoctorPhone').value = doctor.phone;
                        document.getElementById('modalDoctorIntroduction').value = doctor.introduction || '';
                        document.getElementById('doctorModalTitle').textContent = '编辑医生';
                        document.getElementById('doctorModal').style.display = 'block';
                    } else {
                        alert('获取医生信息失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取医生信息失败');
                });
        }
        
        // 保存医生
        function saveDoctor() {
            const doctorId = document.getElementById('doctorId').value;
            const doctorData = {
                name: document.getElementById('modalDoctorName').value,
                gender: document.getElementById('modalDoctorGender').value,
                age: parseInt(document.getElementById('modalDoctorAge').value),
                department: document.getElementById('modalDoctorDepartment').value,
                title: document.getElementById('modalDoctorTitle').value,
                phone: document.getElementById('modalDoctorPhone').value,
                introduction: document.getElementById('modalDoctorIntroduction').value
            };
            
            let url = '/api/doctors';
            let method = 'post';
            
            if (doctorId) {
                url += '/' + doctorId;
                method = 'put';
            }
            
            axios({
                method: method,
                url: url,
                data: doctorData
            })
                .then(response => {
                    if (response.data.code === 200) {
                        alert('保存成功');
                        document.getElementById('doctorModal').style.display = 'none';
                        loadDoctorList(currentDoctorPage);
                    } else {
                        alert('保存失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败');
                });
        }
        
        // 删除医生
        function deleteDoctor(doctorId) {
            if (confirm('确定要删除这个医生吗？')) {
                axios.delete(`/api/doctors/${doctorId}`)
                    .then(response => {
                        if (response.data.code === 200) {
                            alert('删除成功');
                            loadDoctorList(currentDoctorPage);
                        } else {
                            alert('删除失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('删除失败');
                    });
            }
        }
    </script>
</body>
</html>