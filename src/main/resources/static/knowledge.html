<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孕妇健康管理系统 - 知识管理</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/admin.css">
    <style>
        /* 修复搜索表单按钮换行问题 */
        .search-form .form-group:last-child {
            display: flex;
            align-items: flex-end;
        }
        
        .search-form .form-group:last-child .btn {
            margin-right: 10px;
        }
        
        .search-form .form-group:last-child .btn:last-child {
            margin-right: 0;
        }
    </style>
</head>
<body>
    <div class="page fade-in" id="knowledgePage">
        <div class="card">
            <div class="card-header">
                <div class="card-title">知识管理</div>
                <div class="card-actions">
                    <button class="btn btn-primary" id="addKnowledgeBtn">
                        <i class="fas fa-plus"></i> 添加知识
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                <form class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>标题:</label>
                            <input type="text" id="knowledgeTitle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>分类:</label>
                            <select id="knowledgeCategory" class="form-control">
                                <option value="">全部</option>
                                <option value="孕期营养">孕期营养</option>
                                <option value="产前检查">产前检查</option>
                                <option value="分娩准备">分娩准备</option>
                                <option value="产后护理">产后护理</option>
                                <option value="新生儿护理">新生儿护理</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>状态:</label>
                            <select id="knowledgeStatus" class="form-control">
                                <option value="">全部</option>
                                <option value="1">已发布</option>
                                <option value="0">草稿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="searchKnowledgeBtn">
                                <i class="fas fa-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-outline" id="resetKnowledgeBtn">
                                <i class="fas fa-redo"></i> 重置
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- 知识表格 -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>分类</th>
                                <th>作者</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="knowledgeTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="pagination" id="knowledgePagination">
                    <button class="btn btn-outline" id="prevKnowledgePage"><i class="fas fa-chevron-left"></i></button>
                    <span id="knowledgePageInfo">第 1 页，共 1 页</span>
                    <button class="btn btn-outline" id="nextKnowledgePage"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 知识编辑模态框 -->
    <div class="modal" id="knowledgeModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="knowledgeModalTitle">编辑知识</h3>
                <button class="btn btn-outline" id="closeKnowledgeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="knowledgeForm">
                    <input type="hidden" id="knowledgeId">
                    <div class="form-group">
                        <label>标题:</label>
                        <input type="text" id="modalKnowledgeTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>分类:</label>
                        <select id="modalKnowledgeCategory" class="form-control" required>
                            <option value="">请选择分类</option>
                            <option value="孕期营养">孕期营养</option>
                            <option value="产前检查">产前检查</option>
                            <option value="分娩准备">分娩准备</option>
                            <option value="产后护理">产后护理</option>
                            <option value="新生儿护理">新生儿护理</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>作者:</label>
                        <input type="text" id="modalKnowledgeAuthor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>状态:</label>
                        <select id="modalKnowledgeStatus" class="form-control" required>
                            <option value="0">草稿</option>
                            <option value="1">已发布</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>内容:</label>
                        <textarea id="modalKnowledgeContent" class="form-control" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelKnowledgeBtn">取消</button>
                <button class="btn btn-primary" id="saveKnowledgeBtn">保存</button>
                <button class="btn btn-success" id="publishKnowledgeBtn">发布</button>
            </div>
        </div>
    </div>

    <script src="./lib/js/vue.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script src="./js/main.js"></script>
    <script>
        // 全局变量
        let currentKnowledgePage = 1;
        let currentKnowledgeSearchTitle = '';
        let currentKnowledgeSearchCategory = '';
        let currentKnowledgeSearchStatus = '';
        let currentUser = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从localStorage获取当前用户信息
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                currentUser = JSON.parse(userStr);
            }
            
            // 加载知识列表
            loadKnowledgeList(1);
            
            // 绑定事件
            bindKnowledgeEvents();
        });
        
        // 绑定知识相关事件
        function bindKnowledgeEvents() {
            // 添加知识按钮
            document.getElementById('addKnowledgeBtn').addEventListener('click', function() {
                // 清空表单
                document.getElementById('knowledgeForm').reset();
                document.getElementById('knowledgeId').value = '';
                document.getElementById('knowledgeModalTitle').textContent = '添加知识';
                
                // 设置默认作者为当前用户
                if (currentUser) {
                    document.getElementById('modalKnowledgeAuthor').value = currentUser.realName || currentUser.username;
                }
                
                // 显示模态框
                document.getElementById('knowledgeModal').style.display = 'block';
            });
            
            // 关闭模态框按钮
            document.getElementById('closeKnowledgeModal').addEventListener('click', function() {
                document.getElementById('knowledgeModal').style.display = 'none';
            });
            
            // 取消按钮
            document.getElementById('cancelKnowledgeBtn').addEventListener('click', function() {
                document.getElementById('knowledgeModal').style.display = 'none';
            });
            
            // 保存知识按钮
            document.getElementById('saveKnowledgeBtn').addEventListener('click', function() {
                saveKnowledge(false);
            });
            
            // 发布知识按钮
            document.getElementById('publishKnowledgeBtn').addEventListener('click', function() {
                saveKnowledge(true);
            });
            
            // 知识查询按钮
            document.getElementById('searchKnowledgeBtn').addEventListener('click', function() {
                currentKnowledgeSearchTitle = document.getElementById('knowledgeTitle').value;
                currentKnowledgeSearchCategory = document.getElementById('knowledgeCategory').value;
                currentKnowledgeSearchStatus = document.getElementById('knowledgeStatus').value;
                loadKnowledgeList(1);
            });
            
            // 知识重置按钮
            document.getElementById('resetKnowledgeBtn').addEventListener('click', function() {
                document.getElementById('knowledgeTitle').value = '';
                document.getElementById('knowledgeCategory').value = '';
                document.getElementById('knowledgeStatus').value = '';
                currentKnowledgeSearchTitle = '';
                currentKnowledgeSearchCategory = '';
                currentKnowledgeSearchStatus = '';
                loadKnowledgeList(1);
            });
            
            // 上一页按钮
            document.getElementById('prevKnowledgePage').addEventListener('click', function() {
                if (currentKnowledgePage > 1) {
                    loadKnowledgeList(currentKnowledgePage - 1);
                }
            });
            
            // 下一页按钮
            document.getElementById('nextKnowledgePage').addEventListener('click', function() {
                loadKnowledgeList(currentKnowledgePage + 1);
            });
        }
        
        // 加载知识列表
        function loadKnowledgeList(page, title = '', category = '', status = '') {
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('size', 10);
            
            if (title || currentKnowledgeSearchTitle) {
                params.append('title', title || currentKnowledgeSearchTitle);
            }
            if (category || currentKnowledgeSearchCategory) {
                params.append('category', category || currentKnowledgeSearchCategory);
            }
            if (status || currentKnowledgeSearchStatus) {
                params.append('status', status || currentKnowledgeSearchStatus);
            }
            
            axios.get(`/api/knowledge/page?${params.toString()}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const data = response.data.data;
                        renderKnowledgeTable(data.records);
                        updateKnowledgePagination(data);
                        currentKnowledgePage = data.current;
                    } else {
                        alert('加载知识列表失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('加载知识列表失败');
                });
        }
        
        // 渲染知识表格
        function renderKnowledgeTable(knowledges) {
            const tbody = document.getElementById('knowledgeTableBody');
            tbody.innerHTML = '';
            
            if (!knowledges || knowledges.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="7" class="text-center">暂无数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            knowledges.forEach(knowledge => {
                // 状态转换
                let statusText = '未知';
                let statusClass = '';
                if (knowledge.status === 1) {
                    statusText = '已发布';
                    statusClass = 'status-published';
                } else if (knowledge.status === 0) {
                    statusText = '草稿';
                    statusClass = 'status-draft';
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${knowledge.id || ''}</td>
                    <td>${knowledge.title || ''}</td>
                    <td>${knowledge.category || ''}</td>
                    <td>${knowledge.author || ''}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${formatDate(knowledge.createdTime) || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editKnowledge(${knowledge.id})">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKnowledge(${knowledge.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 更新分页信息
        function updateKnowledgePagination(pageInfo) {
            document.getElementById('knowledgePageInfo').textContent = 
                `第 ${pageInfo.current} 页，共 ${pageInfo.pages} 页`;
            
            // 禁用/启用分页按钮
            document.getElementById('prevKnowledgePage').disabled = pageInfo.current === 1;
            document.getElementById('nextKnowledgePage').disabled = pageInfo.current === pageInfo.pages;
        }
        
        // 编辑知识
        function editKnowledge(knowledgeId) {
            axios.get(`/api/knowledge/${knowledgeId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const knowledge = response.data.data;
                        document.getElementById('knowledgeId').value = knowledge.id;
                        document.getElementById('modalKnowledgeTitle').value = knowledge.title;
                        document.getElementById('modalKnowledgeCategory').value = knowledge.category;
                        document.getElementById('modalKnowledgeAuthor').value = knowledge.author;
                        document.getElementById('modalKnowledgeStatus').value = knowledge.status;
                        document.getElementById('modalKnowledgeContent').value = knowledge.content;
                        document.getElementById('knowledgeModalTitle').textContent = '编辑知识';
                        document.getElementById('knowledgeModal').style.display = 'block';
                    } else {
                        alert('获取知识信息失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取知识信息失败');
                });
        }
        
        // 保存知识
        function saveKnowledge(publish = false) {
            const knowledgeId = document.getElementById('knowledgeId').value;
            const knowledgeData = {
                title: document.getElementById('modalKnowledgeTitle').value,
                category: document.getElementById('modalKnowledgeCategory').value,
                author: document.getElementById('modalKnowledgeAuthor').value,
                content: document.getElementById('modalKnowledgeContent').value,
                status: publish ? 1 : parseInt(document.getElementById('modalKnowledgeStatus').value)
            };
            
            // 表单验证
            if (!knowledgeData.title) {
                alert('请输入标题');
                return;
            }
            if (!knowledgeData.category) {
                alert('请选择分类');
                return;
            }
            if (!knowledgeData.author) {
                alert('请输入作者');
                return;
            }
            if (!knowledgeData.content) {
                alert('请输入内容');
                return;
            }
            
            let url = '/api/knowledge';
            let method = 'post';
            
            if (knowledgeId) {
                url += '/' + knowledgeId;
                method = 'put';
            }
            
            axios({
                method: method,
                url: url,
                data: knowledgeData
            })
                .then(response => {
                    if (response.data.code === 200) {
                        alert(publish ? '发布成功' : '保存成功');
                        document.getElementById('knowledgeModal').style.display = 'none';
                        loadKnowledgeList(currentKnowledgePage);
                    } else {
                        alert('保存失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败');
                });
        }
        
        // 删除知识
        function deleteKnowledge(knowledgeId) {
            if (confirm('确定要删除这个知识吗？')) {
                axios.delete(`/api/knowledge/${knowledgeId}`)
                    .then(response => {
                        if (response.data.code === 200) {
                            alert('删除成功');
                            loadKnowledgeList(currentKnowledgePage);
                        } else {
                            alert('删除失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('删除失败');
                    });
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0') + ' ' + 
                   String(date.getHours()).padStart(2, '0') + ':' + 
                   String(date.getMinutes()).padStart(2, '0') + ':' + 
                   String(date.getSeconds()).padStart(2, '0');
        }
    </script>
</body>
</html>